<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Twister: user `${user}`</title>
	<meta name="author" content="Cristi Constantin">
	<meta name="description" content="Central Engine users...">
	<!-- Le styles -->
	<link href="/static/css/bootstrap.css" rel="stylesheet">
	<style>
		body {
			padding-top: 60px;
			background: #f6f6f6 url(/static/img/bg.png) repeat fixed;
		}
		.hero-unit h1 {margin-top: -25px;}
		.logs_content {font-family: Monospace, DejaVu Sans Mono, Courier New, Courier}
	</style>
	<link rel="shortcut icon" href="/static/favicon.ico" />
	<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
</head>
<body>
<div class="container-fluid">

<ul class="pager" style="position:absolute;margin-top:-45px;"><li class="previous"><a href="/rest">Back</a></li></ul>

<div class="tabbable">
	<ul class="nav nav-pills">
		<li class="active"><a href="#tab_home" data-toggle="tab"> <i class="icon-user"></i> Home </a></li>
		<li><a href="#tab_proc" data-toggle="tab"> <i class="icon-tasks"></i> Processes </a></li>
		<li><a href="#tab_logs" data-toggle="tab"> <i class="icon-th-list"></i> Logs </a></li>
	</ul>
	<div class="tab-content">

	<div class="tab-pane active" id="tab_home">
	<div class="hero-unit" style="border: 1px solid #aaf">
		<h1>User `${user}`</h1><br>

		<table class="table table-bordered">
			<tr><td width="200"><b>Status</b></td><td><span id="user_status">${status}</span>
				<small>(<a href="http://${host}/rest/setUserStatus/${user}/2"><i class="icon-play"></i> start</a>&nbsp; |
				<a href="http://${host}/rest/setUserStatus/${user}/0"><i class="icon-stop"></i> stop</a>&nbsp; |
				<a href="http://${host}/rest/resetUser/${user}"><i class="icon-warning-sign"></i> reset!</a> )</small>
			</td></tr>
			<tr><td><b>Master config</b></td><td><span id="master_config">${master_config}</span></td></tr>
			<tr><td><b>Project config</b></td><td><span id="proj_config">${proj_config}</span></td></tr>
			<tr><td><b>Logs path</b></td><td><span id="logs_path">${logs_path}</span></td></tr>
			<tr><td><b>EP files</b></td><td>${eps_file}</td></tr>
		</table>
	</div>
	</div> <!-- End of tab-1 -->

<%
from datetime import datetime
from binascii import hexlify as encode
now = datetime.today()
diffs = []
if now.second < 59:
	now_str = now.replace(second=now.second+1).strftime('%Y-%m-%d %H:%M:%S')
else:
	now_str = now.replace(minute=now.minute+1, second=0).strftime('%Y-%m-%d %H:%M:%S')
for ep in eps:
	tmp_now_str = eps[ep].get('last_seen_alive', now_str)
	diff_time = now - datetime.strptime(tmp_now_str, '%Y-%m-%d %H:%M:%S')
	diffs.append(diff_time.seconds)
%>

	<div class="tab-pane" id="tab_proc">
	<div class="hero-unit" style="border: 1px solid #aaf">
		<h1>Processes for `${user}`</h1><br>
		<div class="tabbable tabs-left">
		<ul class="nav nav-tabs">
		% for ep in eps:
			<li${' class="refresh_eps active"' if loop.first else ' class="refresh_eps"'}><a href="/rest/eps/${user}/${encode(ep)}" data-target="#${encode(ep)}" data-toggle="tabajax">
			<i class="${'icon-ok-sign' if diffs[loop.index] < 10 else 'icon-warning-sign'}"></i>
			% if ep_statuses[loop.index] == 'running':
			<i class="icon-play"></i>
			% elif ep_statuses[loop.index] == 'paused':
			<i class="icon-pause"></i>
			% else:
			<i class="icon-stop"></i>
			% endif
			${ep} </a></li>
		% endfor
		</ul>

		<div class="tab-content">
		% for ep in eps:
			<div class="tab-pane${' active' if loop.first else ''}" id="${encode(ep)}" style="margin-top:-10px"></div>
		% endfor
		</div>
		</div> <!-- End of tabbable -->
	</div>
	</div> <!-- End of tab-2 -->

	<div class="tab-pane" id="tab_logs">
	<div class="hero-unit" style="border: 1px solid #aaf">
		<h1>Logs for `${user}`</h1><br>
		<div class="tabbable tabs-left">
		<ul class="nav nav-tabs">
		% for log in sorted(logs.keys()):
			<li${' class="refresh_logs active"' if loop.first else ' class="refresh_logs"'}><a href="/rest/logs/${user}/${log}" data-target="#${log}" data-toggle="tabajax">
			<i class="icon-th-list"></i> ${log} </a></li>
		% endfor
		</ul>

		<div class="tab-content logs_content">
		% for log in sorted(logs.keys()):
			<div class="tab-pane${' active' if loop.first else ''}" id="${log}"></div>
		% endfor
		</div>
		</div> <!-- End of logs tabbable -->
	</div>
	</div> <!-- End of tab-3 -->

	</div> <!-- End of tab-content -->
</div> <!-- End of tabbable -->
</div>

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>

<script type="text/javascript">

// Show tab from hash link
var activeTab = $('[href="' + location.hash + '"]');
activeTab && activeTab.tab('show');
// On pill shown, change window location
$(".nav-pills a").on("shown", function (e) {
	window.location.hash = e.target.hash;
});

function updateUserStats() {
	var refresh_int = 1500; // update every X ms
	var status_dict = ${exec_status};
	var updt_usr = function() {
		$.getJSON("/rest/json_all",
			// On success, execute the following :
			function(jdata) {
				$("span#user_status").text(status_dict[ jdata["${user}"]["status"] ]); // User status
				$("span#master_config").text(jdata["${user}"]["config_path"]); // User master config
				$("span#proj_config").text(jdata["${user}"]["tests_path"]);    // User project config
				$("span#logs_path").text(jdata["${user}"]["logs_path"]);       // User logs
			});
		setTimeout(updt_usr, refresh_int);
	}
	setTimeout(updt_usr, refresh_int);
};

// Ajax tabs
$('[data-toggle="tabajax"]').click(function(e) {
	e.preventDefault();
	$this = $(this);
	var loadurl = $(this).attr("href");
	var targ = $(this).attr("data-target");
	$(targ).load(loadurl, function() {
		$this.tab("show");
	});
});

// Start updating user stats
updateUserStats();
// Simulate click on active ajax tabs
$('[data-toggle="tabajax"][.active]').click();
</script>

</body>
</html>
