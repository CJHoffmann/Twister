<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Twister: user `${user}`</title>
	<meta name="author" content="Cristi Constantin">
	<meta name="description" content="Central Engine users...">
	<!-- Le styles -->
	<link href="/static/css/bootstrap.css" rel="stylesheet">
	<style>
		body {
			padding-top: 60px;
			background: #f6f6f6 url(/static/img/bg.png) repeat fixed;
		}
		.hero-unit h1 {margin-top: -25px;}
		.logs_content {font-family: Monospace, DejaVu Sans Mono, Courier New, Courier}
	</style>
	<link rel="shortcut icon" href="/static/favicon.ico" />
	<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
</head>
<body>
<div class="container-fluid">

<ul class="pager" style="position:absolute;margin-top:-45px;"><li class="previous"><a href="/rest">Back</a></li></ul>

<div class="tabbable">
	<ul class="nav nav-pills">
		<li class="active"><a href="#home" data-toggle="tab"> <i class="icon-user"></i> Home </a></li>
		<li><a href="#tab2" data-toggle="tab"> <i class="icon-tasks"></i> Processes </a></li>
		<li><a href="#tab3" data-toggle="tab"> <i class="icon-th-list"></i> Logs </a></li>
	</ul>
	<div class="tab-content">

	<div class="tab-pane active" id="home">
	<div class="hero-unit" style="border: 1px solid #aaf">
		<h1>User `${user}`</h1><br>

		<table class="table table-bordered">
			<tr><td width="200"><b>Status</b></td><td>${status}
				<small>(<a href="http://${host}/rest/setUserStatus/${user}/2"><i class="icon-play"></i> start</a>&nbsp; |
				<a href="http://${host}/rest/setUserStatus/${user}/0"><i class="icon-stop"></i> stop</a>&nbsp; |
				<a href="http://${host}/rest/resetUser/${user}"><i class="icon-warning-sign"></i> reset!</a> )</small>
			</td></tr>
			<tr><td><b>Master config</b></td><td>${master_config}</td></tr>
			<tr><td><b>Project config</b></td><td>${proj_config}</td></tr>
			<tr><td><b>Logs path</b></td><td>${logs_path}</td></tr>
			<tr><td><b>EP files</b></td><td>${eps_file}</td></tr>
		</table>
	</div>
	</div> <!-- End of tab-1 -->

<%
from datetime import datetime
now = datetime.today()
diffs = []
if now.second < 59:
	now_str = now.replace(second=now.second+1).strftime('%Y-%m-%d %H:%M:%S')
else:
	now_str = now.replace(minute=now.minute+1, second=0).strftime('%Y-%m-%d %H:%M:%S')
for ep in eps:
	tmp_now_str = eps[ep].get('last_seen_alive', now_str)
	diff_time = now - datetime.strptime(tmp_now_str, '%Y-%m-%d %H:%M:%S')
	diffs.append(diff_time.seconds)
%>

	<div class="tab-pane" id="tab2">
	<div class="hero-unit" style="border: 1px solid #aaf">
		<h1>Processes for `${user}`</h1><br>
		<div class="tabbable tabs-left">
		<ul class="nav nav-tabs">
		% for ep in eps:
			<li${' class="active"' if loop.first else ''}><a data-target="#${ep.replace(" ", "_")}" data-toggle="tab">
			<i class="${'icon-ok-sign' if diffs[loop.index] < 10 else 'icon-warning-sign'}"></i>
			% if statuses[loop.index] == 'running':
			<i class="icon-play"></i>
			% elif statuses[loop.index] == 'paused':
			<i class="icon-pause"></i>
			% else:
			<i class="icon-stop"></i>
			% endif
			${ep} </a></li>
		% endfor
		</ul>

		<div class="tab-content">
		% for ep in eps:
			<div class="tab-pane${' active' if loop.first else ''}" id="${ep.replace(" ", "_")}" style="margin-top:-10px">
				<h2> ${ep} (${'%i sec' % diffs[loop.index] if diffs[loop.index] < 10 else 'no service'}) </h2>
				<ul>
				% for suite in eps[ep]['suites']:
					<li>Suite `<small>${suite}</small>` [<b> ${eps[ep]['suites'][suite]['name']} </b>]
						<ol>
						% for file in eps[ep]['suites'][suite]['files']:
							<li>File `<small>${file}</small>` [<b> ${eps[ep]['suites'][suite]['files'][file]['file']} </b>]</li>
						% endfor
						</ol> <!-- End of Files -->
					</li><br>
				% endfor
				</ul> <!-- End of Suites -->
			</div>
		% endfor
		</div>
		</div> <!-- End of tabbable -->
	</div>
	</div> <!-- End of tab-2 -->

	<div class="tab-pane" id="tab3">
	<div class="hero-unit" style="border: 1px solid #aaf">
		<h1>Logs for `${user}`</h1><br>
		<div class="tabbable tabs-left">
		<ul class="nav nav-tabs">
		% for log in sorted(logs.keys()):
			<li${' class="refresh_logs active"' if loop.first else ' class="refresh_logs"'}><a data-target="#div_${log}" data-toggle="tab"> <i class="icon-th-list"></i> ${log} </a></li>
		% endfor
		</ul>

		<div class="tab-content logs_content">
		% for log in sorted(logs.keys()):
			<div class="tab-pane${' active' if loop.first else ''}" id="div_${log}" style="margin-top:-10px">
			<h2> ${log} </h2>
			<span id="${log}">Logs...</span>
			</div>
		% endfor
		</div>
		</div> <!-- End of logs tabbable -->
	</div>
	</div> <!-- End of tab-3 -->

	</div> <!-- End of tab-content -->
</div> <!-- End of tabbable -->
</div>

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>

<script type="text/javascript">
// Javascript to enable link to tab
var activeTab = $('[href="' + location.hash + '"]');
activeTab && activeTab.tab('show');
// On pill shown, change window location
$(".nav-pills a").on("shown", function (e) {
	window.location.hash = e.target.hash;
});

function getServerLogs(log_name) {
	$.getJSON("/rest/json_logs/${user}/" + log_name,
		// On success, execute the following :
		function(html) {
			$("#" + log_name).html(html);
	});
};
$(".refresh_logs").click(function () {
	$(this).find("i").after(' <i class="updating_logs icon-refresh"></i> ');
	getServerLogs( $.trim($(this).text()) );
	$(".updating_logs").fadeOut(1500, "linear", function() {$(".updating_logs").remove();});
});
// Simulate click on first log
$(".refresh_logs").click();

</script>

</body>
</html>
